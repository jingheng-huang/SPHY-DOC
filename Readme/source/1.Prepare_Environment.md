# Set Up the Environment

## Download and Install Visual Studio Code (VS Code)

Visual Studio Code is a code editor. which can be downloaded from here 

- [VS Code](https://code.visualstudio.com/) 

```{note}
Some older servers do not support connections to the latest version of VS Code.  
If you are using an older server, it is recommended to use **version 1.85.2 or earlier**.

You can also use other code editors, but VScode seems the most powerful one.
```

---

## Connect VS Code to the Cluster and WSL

```{note}
* If you do not plan to use **Auto-calibration**, then a cluster is not required.
* On Windows, you can simply connect VS Code to WSL to run the model.
  - install WSL on windows
  - Search **WSL** extension on VS code store and install.
  - Connect WSL in VS code.

How to install WSL and how to connect WSL to VS code is very straightforward. Refer to:
- [Install WSL](https://learn.microsoft.com/en-us/windows/wsl/install)  
- [VS Code Remote WSL](https://code.visualstudio.com/docs/remote/wsl)

<span style="color:blue"> I usually connect the VScode to both the cluster and the WSL. I do pre-processing on WSL, and then upload all the files
to the cluster to run the model.This is because the Pre-Processing tool includes a database that requires a large amount of storage (~200GB), and using such storage on the cluster is very expensive.
</span>
```

* Install the **Remote - SSH** Extension

![Install Remote SSH Extension](../images/install_ssh.png)

* Configure the Cluster **Host Information**

![open configure](../images/open_config.png)

After opening the SSH config file, enter the login details for your cluster.

````{admonition} Example A
Normal connection:

```bash
Host cancon.hpccube.com
    HostName cancon.hpccube.com
    Port 65023
    # IdentityFile <path_to_id_rsa.pub>
    User acvfmokn51
```
````

````{admonition} Example B
Some clusters require jumping to an available compute node.  
E.g., You can type `sinfo` to check the available nodes in the Slurm system:

```bash
Host unifr
    HostName beo05.unifr.ch
    User huangj
    Port 22
    # IdentityFile <path_to_id_rsa.pub>

Host node-compute
    HostName node84
    ProxyJump unifr
    User huangj
```
````

````{note}
ðŸ‘‰ If you donâ€™t want to enter your password every time, you need to create a `SSH key`.  
In some clusters, this is mandatory.

* Open a bash shell or command line on Windows, and type:

```bash
ssh-keygen -t rsa -b 4096
```

* Under `C:\Users\XXX\.ssh` (XXX = your username), you will find `id_rsa.pub`.  
  Copy the contents into `~/.ssh/authorized_keys` on the cluster.

* For Mac users, the procedure is the same:  
  https://mdl.library.utoronto.ca/technology/tutorials/generating-ssh-key-pairs-mac

**Reference:**  
https://docs.github.com/en/authentication/connecting-to-github-with-ssh/generating-a-new-ssh-key-and-adding-it-to-the-ssh-agent
````

* Connect to the Server

```{note}
The first connection may take some time.
```

![connect to server](../images/connect_to_server.png)

---

## Create the Conda Environment

Use **Conda** or **Mamba** to create an isolated Python environment for SPHY. <span style="color:blue"> I usually do both on WSL and cluster. 
The WSL is for preparing the model input files, and the cluster is for running the model. </span>

* Open VS Code and open a terminal

![connect to server](../images/open_bash.png)

Connect to WSL or/and SSH. Install the Linux version of Miniconda:

```bash
wget https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh
bash ~/Miniconda3-latest-Linux-x86_64.sh
source ~/.bashrc
```

```{note}
If you are using WSL, make sure you open the correct WSL distribution.
```

* Create the Environment from the YAML File

Download the yaml file from here [jingheng's Github](https://github.com/jingheng-huang/SphySetup)  and Create the environment using the YAML file:


```
conda env create -f environment.yml
```

![alt text](image-43.png)


Once installation is complete, test whether the environment works:

```bash
conda activate pcraster
```

## Install other Required System Packages

Some packages on linux also need to be installed.
Here we need to install `Gdal`, `NCO` and `CDO`.

If you are using Ubuntu:

```bash
sudo apt install nco cdo
sudo apt install gdal-bin libgdal-dev
```

````{note}
The database can be downloaded from [SPHY global database](https://www.dropbox.com/scl/fo/xwegzjtjsuu4khnzut948/APClH3tg_iQVSXqD2SqnFBc?rlkey=4zpzgke2a1wg2pckdkus4llko&st=myfz42qo&dl=0).
It is very large (~200GB) and may take a long time to download. 
````
